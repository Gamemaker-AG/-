<!doctype html>
<html>
<head>
  <meta charset="utf-8">
  <title>Basement Attack</title>
</head>
  <script src="pixi.min.js"></script>
<body>
  <script type="text/javascript">
		var Container = PIXI.Container,
			autoDetectRenderer = PIXI.autoDetectRenderer,
			loader = PIXI.loader,
			resources = PIXI.loader.resources,
			TextureCache = PIXI.utils.TextureCache,
			Texture = PIXI.Texture,
			Graphics = PIXI.Graphics,
			Text = PIXI.Text,
			Sprite = PIXI.Sprite;
			
		//Create the renderer
		var renderer = PIXI.autoDetectRenderer(800, 600);

		renderer.backgroundColor = 0xFFFFFF;
		renderer.view.style.border = "1px dotted black";

		//Add the canvas to the HTML document
		document.body.appendChild(renderer.view);

		//Create a container object called the `stage`
		var stage = new PIXI.Container();
		
		
		var enemy, enemies = [], towers = [], enemySteps, gameTime = [], gameTimeCounter, fieldsize, gameover, credits, activeTower, buildedTowers = [];
		
		setup();

		function setup() {
			startScene = new Container();
			startScene.visible = false;
			stage.addChild(startScene);
			
			gameScene = new Container();
			gameScene.visible = false;
			stage.addChild(gameScene);
			
			gameOverScene = new Container();
			gameOverScene.visible = false;
			stage.addChild(gameOverScene);
			
			var newGame = new Text(
				"New Game",
				{fontFamily: "Arial", fontSize: 32, fill: "blue"}
			);
			newGame.position.set(100, 100);
			startScene.addChild(newGame);
			
			var newGame = new Text(
				"New Game",
				{fontFamily: "Arial", fontSize: 32, fill: "blue"}
			);
			newGame.position.set(100, 100);
			gameOverScene.addChild(newGame);
			
			var msgGameOver = new Text(
				"Game Over!",
				{fontFamily: "Arial", fontSize: 32, fill: "black"}
			);
			msgGameOver.position.set(400-msgGameOver/2, 600);
			gameOverScene.addChild(msgGameOver);
			
			
			fieldsize = 40;
			credits = 100;
			activeTower = -1;
			gameover = false;
		// print ground
			var ground = new Graphics();
			ground.beginFill(0x88BB22);
			ground.drawRect(0, 0, 600, 600);
			ground.endFill();
			ground.x = 0;
			ground.y = 0;
			gameScene.addChild(ground);
		// print enemy-path
			var enemyPath = new Graphics();
			enemyPath.beginFill(0x999999);
			enemyPath.drawRect(0, 0, fieldsize, fieldsize*8);
			enemyPath.endFill();
			enemyPath.x = fieldsize*3;
			enemyPath.y = 0;
			gameScene.addChild(enemyPath);
			var enemyPath = new Graphics();
			enemyPath.beginFill(0x999999);
			enemyPath.drawRect(0, 0, fieldsize*5, fieldsize);
			enemyPath.endFill();
			enemyPath.x = fieldsize*4;
			enemyPath.y = fieldsize*7;
			gameScene.addChild(enemyPath);
			var enemyPath = new Graphics();
			enemyPath.beginFill(0x999999);
			enemyPath.drawRect(0, 0, fieldsize, fieldsize*8);
			enemyPath.endFill();
			enemyPath.x = fieldsize*9;
			enemyPath.y = fieldsize*7;
			gameScene.addChild(enemyPath);
			
		// horizontal lines
			for( var i = 1; i < 15; i++) {
				var line = new Graphics();
				line.lineStyle(1, 0x000000, 1);
				line.moveTo(0, fieldsize*i);
				line.lineTo(600, fieldsize*i);
				gameScene.addChild(line);
			}
		// vertical lines
			for( var i = 1; i < 15; i++) {
				var line = new Graphics();
				line.lineStyle(1, 0x000000, 1);
				line.moveTo(fieldsize*i, 0);
				line.lineTo(fieldsize*i, 800);
				gameScene.addChild(line);
			}
			
			var menu = new Graphics();
			menu.beginFill(0xBBBBBB);
			menu.drawRect(0, 0, 200, 600);
			menu.endFill();
			menu.x = 600;
			menu.y = 0;
			gameScene.addChild(menu);
			
			var credits = new Text(
				"Credits: "+credits,
				{fontFamily: "Arial", fontSize: 16, fill: "black"}
			);
			credits.position.set(610, 60);
			gameScene.addChild(credits);
			
			var menuTower = new Graphics();
			menuTower.beginFill(0x008800);
			menuTower.drawRect(0, 0, fieldsize-1, fieldsize-1);
			menuTower.endFill();
			menuTower.x = 610;
			menuTower.y = 100;
			towers.push(menuTower);
			
			var menuTower = new Text(
				"Weak Tower\n30 Credits",
				{fontFamily: "Arial", fontSize: 16, fill: "black"}
			);
			menuTower.position.set(660, 105);
			gameScene.addChild(menuTower);
			
			var menuTower = new Graphics();
			menuTower.beginFill(0xDDDD00);
			menuTower.drawRect(0, 0, fieldsize-1, fieldsize-1);
			menuTower.endFill();
			menuTower.x = 610;
			menuTower.y = 100+fieldsize*2;
			towers.push(menuTower);
			
			var menuTower = new Text(
				"Stronk Tower\n70 Credits",
				{fontFamily: "Arial", fontSize: 16, fill: "black"}
			);
			menuTower.position.set(660, 105+fieldsize*2);
			gameScene.addChild(menuTower);
			
			var menuTower = new Graphics();
			menuTower.beginFill(0x006688);
			menuTower.drawRect(0, 0, fieldsize-1, fieldsize-1);
			menuTower.endFill();
			menuTower.x = 610;
			menuTower.y = 100+fieldsize*4;
			towers.push(menuTower);
			towers.forEach(function(tower) {
				gameScene.addChild(tower);
			});
			
			var menuTower = new Text(
				"Long Range Tower\n60 Credits",
				{fontFamily: "Arial", fontSize: 16, fill: "black"}
			);
			menuTower.position.set(660, 105+fieldsize*4);
			gameScene.addChild(menuTower);
			
			enemy = new Graphics();
			enemy.beginFill(0xFF0000);
			enemy.drawRect(0, 0, fieldsize-1, fieldsize-1);
			enemy.endFill();
			enemy.x = fieldsize*3;
			enemy.y = 0;
			enemy.checkpointsReached = 0;
			enemy.speed = 1;
			enemies.push(enemy);
			enemies.forEach(function(enemy) {
				gameScene.addChild(enemy);
			});
				
			gameTime = [0, 0];
			gameTimeCounter = 0;
		

			state = start;
			gameLoop();
		}

		function gameLoop() {
		// saves cpu where it is not needed
			if(!gameover || true) {
				gameTime[0]++;
				if(gameTime[0] % 60 == 0) {
					gameTime[1]++;
				}
				requestAnimationFrame(gameLoop);
				state();
				renderer.render(stage);
			}
		}
		
		function start() {
			startScene.visible = true;
			if(gameTime[1] == 1) {
				startScene.visible = false;
				gameScene.visible = true;
				state = play;
			}
		}

		function play() {
		enemies.forEach(function(enemy){
			enemySteps = enemy.speed;
			enemy.vx = 0;
			enemy.vy = 0;
			if(enemy.checkpointsReached == 0) {
				if(enemy.y + enemySteps > fieldsize*7) {
					enemySteps -= fieldsize*7 - enemy.y + 1;
					enemy.vy = fieldsize*7 - enemy.y + 1;
					enemy.checkpointsReached = 1;
				}
				else {
					enemy.vy = enemySteps;
					enemySteps = 0;
				}
			}
			if(enemy.checkpointsReached == 1) {
				if(enemy.x + enemySteps > fieldsize*9) {
					enemySteps -= fieldsize*9 - enemy.x;
					enemy.vx = fieldsize*9 - enemy.x;
					enemy.checkpointsReached = 2;
				}
				else {
					enemy.vx = enemySteps;
					enemySteps = 0;
				}
			}
			if(enemy.checkpointsReached == 2) {
				if(enemy.y + enemySteps > fieldsize*14) {
					enemySteps -= fieldsize*14 - enemy.y + 1;
					enemy.vy = fieldsize*14 - enemy.y + 1;
					enemy.checkpointsReached = 3;
				}
				else {
					enemy.vy = enemySteps;
					enemySteps = 0;
				}
			}
			if(enemy.checkpointsReached == 3) {
				gameover = true;
				gameScene.visible = false;
				gameOverScene.visible = true;
			}
			enemy.x += enemy.vx;
			enemy.y += enemy.vy;
		});
		
		if(gameTime[0] == 120) {
				activateTower(1);
			}
		}

		function end() {
			gameScene.visible = false;
			gameOverScene.visible = true;
		}
		
		function activateTower(number) {
			if(activeTower > -1) {
				towers[activeTower].lineStyle(0, 0x000000, 1);
				towers[activeTower].drawRect(0, 0, fieldsize-1, fieldsize-1);
			}
			towers[number].lineStyle(3, 0x000000, 1);
			towers[number].drawRect(0, 0, fieldsize-1, fieldsize-1);
			activeTower = number;
			buildTower(35, 45);
		}
		
		function buildTower(x, y) {
			x /= fieldsize;
			y /= fieldsize;
			console.log(x+"-"+y);
		}
		
		function isValidTowerPosition(x, y) {
			buildedTowers.forEach(function(tower) {
				if(tower.x == x && tower.y == y) {
					return false;
				}
			});
			
			if(x > 14) {
				return false;
			}
			if(x <= 6 && y != 3) {
				return true;
			}
			else if(x == 7 && (y <= 2 || y >= 10)) {
				return true
			}
			else if(x >= 8 && y != 9) {
				return true
			}
			return false;
		}
  </script>
</body>
</html>